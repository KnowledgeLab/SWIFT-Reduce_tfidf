<project><!-- CACHE ID 1391117349 28222 yahoo-headnode-no-provenance -->
  <import file="sys.xml"/>
  <import file="scheduler.xml"/>
  <import file="rlog.xml"/>
  <import file="vdl.k"/>
  <types>
     <xs:schema targetNamespace="http://ci.uchicago.edu/swift/2009/02/swiftscript" xmlns="http://ci.uchicago.edu/swift/2009/02/swiftscript" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xs="http://www.w3.org/2001/XMLSchema">
      	   <xs:simpleType name="file">
      	   <xs:restriction base="string"/>
      	   </xs:simpleType>
      	   <xs:simpleType name="script">
      	   <xs:restriction base="string"/>
      	   </xs:simpleType>
     </xs:schema>
  </types>
  <global name="swift#string#17017">
    <vdl:new type="string" value="collection.tfidf.csv" />
  </global>
  <global name="swift#string#17004">
    <vdl:new type="string" value=".txt" />
  </global>
  <global name="swift#string#17001">
    <vdl:new type="string" value="topn" />
  </global>
  <global name="swift#string#17011">
    <vdl:new type="string" value="/collection.tf" />
  </global>
  <global name="swift#string#17013">
    <vdl:new type="string" value="/collection.vocab" />
  </global>
  <global name="swift#string#17000">
    <vdl:new type="string" value="data" />
  </global>
  <global name="swift#string#17015">
    <vdl:new type="string" value=".tfidf" />
  </global>
  <global name="swift#string#17005">
    <vdl:new type="string" value="File : %s\n" />
  </global>
  <global name="swift#string#17002">
    <vdl:new type="string" value="minf" />
  </global>
  <global name="swift#string#17009">
    <vdl:new type="string" value=".vocab" />
  </global>
  <global name="swift#string#17007">
    <vdl:new type="string" value=".tf" />
  </global>
  <global name="swift#int#1">
    <vdl:new type="int" value="1" />
  </global>
  <element name="calculate__tf" arguments="tf,vocab,calc_tf,dir,doc,topn,minf" _defline="4">
     
     
     
     
     
     
     
    <unitStart name="calculate__tf" line="4" type="PROCEDURE" outputs="tf,vocab"/>
    <vdl:execute>
      <vdl:tr>python</vdl:tr>
      <vdl:stagein var="{calc_tf}"/>
      <vdl:stagein var="{dir}"/>
      <vdl:stagein var="{doc}"/>
      <vdl:stagein var="{topn}"/>
      <vdl:stagein var="{minf}"/>
      <vdl:stageout var="{tf}"/>
      <vdl:stageout var="{vocab}"/>

      <vdl:arguments>
        <swiftscript:filename _traceline="6">
         <variable>calc_tf</variable> 
        </swiftscript:filename>
        <variable>dir</variable>
        <variable>topn</variable>
        <variable>minf</variable>
        <swiftscript:filename _traceline="6">
         <variable>tf</variable> 
        </swiftscript:filename>
        <swiftscript:filename _traceline="6">
         <variable>vocab</variable> 
        </swiftscript:filename>
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{tf}"/>
    <vdl:closedataset var="{vocab}"/>
    <unitEnd name="calculate__tf" line="4" type="PROCEDURE"/></element>

  <element name="merger" arguments="o,merge,doc" _defline="9">
     
     
     
    <unitStart name="merger" line="9" type="PROCEDURE" outputs="o"/>
    <vdl:execute>
      <vdl:tr>python_local</vdl:tr>
      <vdl:stagein var="{merge}"/>
      <vdl:stagein var="{doc}"/>
      <vdl:stageout var="{o}"/>

      <vdl:arguments>
        <swiftscript:filename _traceline="11">
         <variable>merge</variable> 
        </swiftscript:filename>
        <swiftscript:filename _traceline="11">
         <variable>o</variable> 
        </swiftscript:filename>
        <swiftscript:filenames _traceline="11">
         <variable>doc</variable> 
        </swiftscript:filenames>
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{o}"/>
    <unitEnd name="merger" line="9" type="PROCEDURE"/></element>

  <element name="calculate__idf" arguments="tfidf,calc,vocab,tf,key,report_top,min_freq" _defline="14">
     
     
     
     
     
     
     
    <unitStart name="calculate__idf" line="14" type="PROCEDURE" outputs="tfidf"/>
    <vdl:execute>
      <vdl:tr>python</vdl:tr>
      <vdl:stagein var="{calc}"/>
      <vdl:stagein var="{vocab}"/>
      <vdl:stagein var="{tf}"/>
      <vdl:stagein var="{key}"/>
      <vdl:stagein var="{report_top}"/>
      <vdl:stagein var="{min_freq}"/>
      <vdl:stageout var="{tfidf}"/>

      <vdl:arguments>
        <swiftscript:filename _traceline="16">
         <variable>calc</variable> 
        </swiftscript:filename>
        <variable>report_top</variable>
        <variable>min_freq</variable>
        <swiftscript:filename _traceline="16">
         <variable>vocab</variable> 
        </swiftscript:filename>
        <swiftscript:filename _traceline="16">
         <variable>tf</variable> 
        </swiftscript:filename>
        <variable>key</variable>
      </vdl:arguments>
      <vdl:stdout>
        <swiftscript:filename _traceline="16">
         <variable>tfidf</variable> 
        </swiftscript:filename>
      </vdl:stdout>
    </vdl:execute>
    <vdl:closedataset var="{tfidf}"/>
    <unitEnd name="calculate__idf" line="14" type="PROCEDURE"/></element>

  <element name="scrounge" arguments="final,s,i" _defline="19">
     
     
     
    <unitStart name="scrounge" line="19" type="PROCEDURE" outputs="final"/>
    <vdl:execute>
      <vdl:tr>bash</vdl:tr>
      <vdl:stagein var="{s}"/>
      <vdl:stagein var="{i}"/>
      <vdl:stageout var="{final}"/>

      <vdl:arguments>
        <swiftscript:filename _traceline="21">
         <variable>s</variable> 
        </swiftscript:filename>
        <swiftscript:filename _traceline="21">
         <variable>i</variable> 
        </swiftscript:filename>
      </vdl:arguments>
      <vdl:stdout>
        <swiftscript:filename _traceline="21">
         <variable>final</variable> 
        </swiftscript:filename>
      </vdl:stdout>
    </vdl:execute>
    <vdl:closedataset var="{final}"/>
    <unitEnd name="scrounge" line="19" type="PROCEDURE"/></element>

  <set name="dir">
        <vdl:new type="string" dbgname="dir" waitCount="1" _defline="24"/>
  </set>
   
  <set name="report_top">
        <vdl:new type="string" dbgname="report_top" waitCount="1" _defline="25"/>
  </set>
   
  <set name="min_freq">
        <vdl:new type="string" dbgname="min_freq" waitCount="1" _defline="26"/>
  </set>
   
  <set name="calc_tf">
        <vdl:new type="script" dbgname="calc_tf" _defline="29" input="true">
          <vdl:mapping descriptor="single_file_mapper">
            <vdl:parameter name="file" value="calculate_tf_scores.py"/>
          </vdl:mapping>
        </vdl:new>
  </set>
   
  <set name="swift#mapper#17003">
        <vdl:new type="string" dbgname="swift#mapper#17003" _defline=""/>
  </set>
   
  <set name="all_docs">
    <vdl:new type="file[]" dbgname="all_docs" _defline="30" input="true">
      <vdl:mapping descriptor="filesys_mapper">
        <vdl:parameter name="location"><variable>dir</variable></vdl:parameter>
        <vdl:parameter name="suffix"><vdl:new type="string" value=".txt" /></vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="doc_tf">
    <vdl:new type="file[]" dbgname="doc_tf" waitCount="1" _defline="31">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix">doc_tf-79659db9-d4a1-4e53-ba75-da632eb636c6</vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="doc_vocab">
    <vdl:new type="file[]" dbgname="doc_vocab" waitCount="1" _defline="32">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix">doc_vocab-752a15b0-d363-4802-89eb-f8b6e94b5ab6</vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="merge">
        <vdl:new type="script" dbgname="merge" _defline="44" input="true">
          <vdl:mapping descriptor="single_file_mapper">
            <vdl:parameter name="file" value="merge.py"/>
          </vdl:mapping>
        </vdl:new>
  </set>
   
  <set name="swift#mapper#17010">
        <vdl:new type="string" dbgname="swift#mapper#17010" _defline=""/>
  </set>
   
  <set name="all_tf">
    <vdl:new type="file" dbgname="all_tf" _defline="45">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file"><variable>swift#mapper#17010</variable></vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="swift#mapper#17012">
        <vdl:new type="string" dbgname="swift#mapper#17012" _defline=""/>
  </set>
   
  <set name="all_vocab">
    <vdl:new type="file" dbgname="all_vocab" _defline="46">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file"><variable>swift#mapper#17012</variable></vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="tfidf">
    <vdl:new type="file[]" dbgname="tfidf" waitCount="1" _defline="51">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix">tfidf-49f4684f-df12-4ba9-8bb4-54f548d99921</vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="calc_idf">
        <vdl:new type="script" dbgname="calc_idf" _defline="52" input="true">
          <vdl:mapping descriptor="single_file_mapper">
            <vdl:parameter name="file" value="calculate_idf_scores.py"/>
          </vdl:mapping>
        </vdl:new>
  </set>
   
  <set name="concat">
        <vdl:new type="script" dbgname="concat" _defline="60" input="true">
          <vdl:mapping descriptor="single_file_mapper">
            <vdl:parameter name="file" value="concat.sh"/>
          </vdl:mapping>
        </vdl:new>
  </set>
   
  <set name="swift#mapper#17016">
        <vdl:new type="string" dbgname="swift#mapper#17016" _defline=""/>
  </set>
   
  <set name="final">
    <vdl:new type="file" dbgname="final" _defline="61">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file"><variable>swift#mapper#17016</variable></vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <restartLog>
  	<vdl:mains>
		<vdl:startprogressticker />
		<vdl:mainp>
		    <uparallel>
		        <sequential>
		             <vdl:setfieldvalue _traceline="25">
		                 <variable>dir</variable>
		                 <swiftscript:arg _traceline="24">
		                  <variable>swift#string#17000</variable> 
		                 </swiftscript:arg>
		             </vdl:setfieldvalue>
		             <partialCloseDataset var="{dir}"/>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="26">
		                 <variable>report_top</variable>
		                 <swiftscript:arg _traceline="25">
		                  <variable>swift#string#17001</variable> 
		                 </swiftscript:arg>
		             </vdl:setfieldvalue>
		             <partialCloseDataset var="{report_top}"/>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="29">
		                 <variable>min_freq</variable>
		                 <swiftscript:arg _traceline="26">
		                  <variable>swift#string#17002</variable> 
		                 </swiftscript:arg>
		             </vdl:setfieldvalue>
		             <partialCloseDataset var="{min_freq}"/>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="-1">
		                 <variable>swift#mapper#17003</variable>
		                 <variable>swift#string#17004</variable>
		             </vdl:setfieldvalue>

		        </sequential>
		        <sequential>
		          <sequential>
		          <unitStart name="tracef" type="INTERNALPROC" outputs=""/>
		           
		          <tracef _traceline="33">
		          <parallel>
		              <variable>swift#string#17005</variable>
		              <swiftscript:filename _traceline="33">
		               <vdl:getfieldsubscript>
		                <argument name="var"><variable>all_docs</variable></argument>
		                <argument name="subscript"><variable>swift#int#1</variable></argument>
		              </vdl:getfieldsubscript> 
		              </swiftscript:filename>
		          </parallel>
		          </tracef>
		          <unitEnd name="tracef" type="INTERNALPROC"/>
		          </sequential>
		        </sequential>
		        <sequential>
		          <vdl:tparallelFor name="$"_kvar="index" _vvar="doc" refs="doc_tf 1 doc_vocab 1">
		          	<getarrayiterator>
		          		<variable>all_docs</variable>
		          	</getarrayiterator>
		          	<set names="$$, doc">
		          		<each items="{$}"/>
		          	</set>
		          	<set name="index">
		          		<vdl:new type="int" value="{$$}"/>
		          	</set>
		          	<unitStart line="34" type="FOREACH_IT"/>
		          	<set name="swift#mapper#17006">
		          	      <vdl:new type="string" dbgname="swift#mapper#17006" _defline=""/>
		          	</set>
		          	 
		          	<set name="tf">
		          	  <vdl:new type="file" dbgname="tf" _defline="36">
		          	    <vdl:mapping descriptor="single_file_mapper">
		          	      <vdl:parameter name="file"><variable>swift#mapper#17006</variable></vdl:parameter>
		          	    </vdl:mapping>
		          	  </vdl:new>
		          	</set>
		          	 
		          	<set name="swift#mapper#17008">
		          	      <vdl:new type="string" dbgname="swift#mapper#17008" _defline=""/>
		          	</set>
		          	 
		          	<set name="vocab">
		          	  <vdl:new type="file" dbgname="vocab" _defline="37">
		          	    <vdl:mapping descriptor="single_file_mapper">
		          	      <vdl:parameter name="file"><variable>swift#mapper#17008</variable></vdl:parameter>
		          	    </vdl:mapping>
		          	  </vdl:new>
		          	</set>
		          	 
		          	<uparallel>
		          	    <sequential>
		          	      <sequential>
		          	      <unitStart name="tracef" type="INTERNALPROC" outputs=""/>
		          	       
		          	      <tracef _traceline="35">
		          	      <parallel>
		          	          <variable>swift#string#17005</variable>
		          	          <swiftscript:filename _traceline="35">
		          	           <variable>doc</variable> 
		          	          </swiftscript:filename>
		          	      </parallel>
		          	      </tracef>
		          	      <unitEnd name="tracef" type="INTERNALPROC"/>
		          	      </sequential>
		          	    </sequential>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="-1">
		          	             <variable>swift#mapper#17006</variable>
		          	             <swiftscript:strcat _traceline="36">
		          	              <swiftscript:filename _traceline="36">
		          	              <variable>doc</variable> 
		          	             </swiftscript:filename><variable>swift#string#17007</variable> 
		          	             </swiftscript:strcat>
		          	         </vdl:setfieldvalue>

		          	    </sequential>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="-1">
		          	             <variable>swift#mapper#17008</variable>
		          	             <swiftscript:strcat _traceline="37">
		          	              <swiftscript:filename _traceline="37">
		          	              <variable>doc</variable> 
		          	             </swiftscript:filename><variable>swift#string#17009</variable> 
		          	             </swiftscript:strcat>
		          	         </vdl:setfieldvalue>

		          	    </sequential>
		          	    <sequential>
		          	      <calculate__tf _traceline="38">
		          	          <variable>tf</variable>
		          	          <variable>vocab</variable>
		          	          <variable>calc_tf</variable>
		          	          <variable>dir</variable>
		          	          <variable>doc</variable>
		          	          <variable>report_top</variable>
		          	          <variable>min_freq</variable>
		          	      </calculate__tf>

		          	    </sequential>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="40">
		          	             <vdl:getfieldsubscript>
		          	               <argument name="var"><variable>doc_tf</variable></argument>
		          	               <argument name="subscript"><variable>index</variable></argument>
		          	             </vdl:getfieldsubscript>
		          	             <variable>tf</variable>
		          	         </vdl:setfieldvalue>
		          	         <partialCloseDataset var="{doc_tf}"/>
		          	    </sequential>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="41">
		          	             <vdl:getfieldsubscript>
		          	               <argument name="var"><variable>doc_vocab</variable></argument>
		          	               <argument name="subscript"><variable>index</variable></argument>
		          	             </vdl:getfieldsubscript>
		          	             <variable>vocab</variable>
		          	         </vdl:setfieldvalue>
		          	         <partialCloseDataset var="{doc_vocab}"/>
		          	    </sequential>
		          	</uparallel>
		          	<vdl:cleandataset var="{tf}"/>
		          	<vdl:cleandataset var="{vocab}"/>	<unitEnd line="34" type="FOREACH_IT"/>
		          </vdl:tparallelFor>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="-1">
		                 <variable>swift#mapper#17010</variable>
		                 <swiftscript:strcat _traceline="45">
		                  <variable>dir</variable><variable>swift#string#17011</variable> 
		                 </swiftscript:strcat>
		             </vdl:setfieldvalue>

		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="-1">
		                 <variable>swift#mapper#17012</variable>
		                 <swiftscript:strcat _traceline="46">
		                  <variable>dir</variable><variable>swift#string#17013</variable> 
		                 </swiftscript:strcat>
		             </vdl:setfieldvalue>

		        </sequential>
		        <sequential>
		          <merger _traceline="47">
		              <variable>all_tf</variable>
		              <variable>merge</variable>
		              <variable>doc_tf</variable>
		          </merger>

		        </sequential>
		        <sequential>
		          <merger _traceline="48">
		              <variable>all_vocab</variable>
		              <variable>merge</variable>
		              <variable>doc_vocab</variable>
		          </merger>

		        </sequential>
		        <sequential>
		          <vdl:tparallelFor name="$"_kvar="index" _vvar="doc" refs="tfidf 1">
		          	<getarrayiterator>
		          		<variable>all_docs</variable>
		          	</getarrayiterator>
		          	<set names="$$, doc">
		          		<each items="{$}"/>
		          	</set>
		          	<set name="index">
		          		<vdl:new type="int" value="{$$}"/>
		          	</set>
		          	<unitStart line="53" type="FOREACH_IT"/>
		          	<set name="swift#mapper#17014">
		          	      <vdl:new type="string" dbgname="swift#mapper#17014" _defline=""/>
		          	</set>
		          	 
		          	<set name="tfidf_t">
		          	  <vdl:new type="file" dbgname="tfidf_t" _defline="54">
		          	    <vdl:mapping descriptor="single_file_mapper">
		          	      <vdl:parameter name="file"><variable>swift#mapper#17014</variable></vdl:parameter>
		          	    </vdl:mapping>
		          	  </vdl:new>
		          	</set>
		          	 
		          	<uparallel>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="-1">
		          	             <variable>swift#mapper#17014</variable>
		          	             <swiftscript:strcat _traceline="54">
		          	              <swiftscript:filename _traceline="54">
		          	              <variable>doc</variable> 
		          	             </swiftscript:filename><variable>swift#string#17015</variable> 
		          	             </swiftscript:strcat>
		          	         </vdl:setfieldvalue>

		          	    </sequential>
		          	    <sequential>
		          	      <calculate__idf _traceline="55">
		          	      <parallel>
		          	          <variable>tfidf_t</variable>
		          	          <variable>calc_idf</variable>
		          	          <variable>all_vocab</variable>
		          	          <variable>all_tf</variable>
		          	          <swiftscript:filename _traceline="55">
		          	           <variable>doc</variable> 
		          	          </swiftscript:filename>
		          	          <variable>report_top</variable>
		          	          <variable>min_freq</variable>
		          	      </parallel>
		          	      </calculate__idf>

		          	    </sequential>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="57">
		          	             <vdl:getfieldsubscript>
		          	               <argument name="var"><variable>tfidf</variable></argument>
		          	               <argument name="subscript"><variable>index</variable></argument>
		          	             </vdl:getfieldsubscript>
		          	             <variable>tfidf_t</variable>
		          	         </vdl:setfieldvalue>
		          	         <partialCloseDataset var="{tfidf}"/>
		          	    </sequential>
		          	</uparallel>
		          	<vdl:cleandataset var="{tfidf_t}"/>	<unitEnd line="53" type="FOREACH_IT"/>
		          </vdl:tparallelFor>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="-1">
		                 <variable>swift#mapper#17016</variable>
		                 <swiftscript:strcat _traceline="61">
		                  <variable>dir</variable><variable>swift#string#17017</variable> 
		                 </swiftscript:strcat>
		             </vdl:setfieldvalue>

		        </sequential>
		        <sequential>
		          <scrounge _traceline="62">
		              <variable>final</variable>
		              <variable>concat</variable>
		              <variable>tfidf</variable>
		          </scrounge>

		        </sequential>
		    </uparallel>
		</vdl:mainp>
		<vdl:stopprogressticker />
	</vdl:mains>
  </restartLog>
  <vdl:cleandataset var="{final}"/>
  <vdl:cleandataset var="{all_vocab}"/>
  <vdl:cleandataset var="{tfidf}"/>
  <vdl:cleandataset var="{calc_idf}"/>
  <vdl:cleandataset var="{merge}"/>
  <vdl:cleandataset var="{calc_tf}"/>
  <vdl:cleandataset var="{all_tf}"/>
  <vdl:cleandataset var="{concat}"/>
  <vdl:cleandataset var="{doc_vocab}"/>
  <vdl:cleandataset var="{all_docs}"/>
  <vdl:cleandataset var="{doc_tf}"/>
  <vdl:cleandataset shutdown="true"/>
</project>
