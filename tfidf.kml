<project><!-- CACHE ID 1391117349 28222 yahoo-headnode-no-provenance -->
  <import file="sys.xml"/>
  <import file="scheduler.xml"/>
  <import file="rlog.xml"/>
  <import file="vdl.k"/>
  <types>
     <xs:schema targetNamespace="http://ci.uchicago.edu/swift/2009/02/swiftscript" xmlns="http://ci.uchicago.edu/swift/2009/02/swiftscript" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xs="http://www.w3.org/2001/XMLSchema">
      	   <xs:simpleType name="file">
      	   <xs:restriction base="string"/>
      	   </xs:simpleType>
      	   <xs:simpleType name="script">
      	   <xs:restriction base="string"/>
      	   </xs:simpleType>
     </xs:schema>
  </types>
  <global name="swift#string#17014">
    <vdl:new type="string" value="/collection.tfidf.csv" />
  </global>
  <global name="swift#string#17004">
    <vdl:new type="string" value=".txt" />
  </global>
  <global name="swift#string#17001">
    <vdl:new type="string" value="topn" />
  </global>
  <global name="swift#string#17010">
    <vdl:new type="string" value="/collection.tf" />
  </global>
  <global name="swift#string#17000">
    <vdl:new type="string" value="data" />
  </global>
  <global name="swift#string#17012">
    <vdl:new type="string" value=".tfidf" />
  </global>
  <global name="swift#string#17002">
    <vdl:new type="string" value="minf" />
  </global>
  <global name="swift#string#17008">
    <vdl:new type="string" value=".tf.csv" />
  </global>
  <global name="swift#string#17006">
    <vdl:new type="string" value=".tf" />
  </global>
  <element name="calculate__tf" arguments="tf,tf_csv,calc_tf,dir,doc,topn,minf" _defline="4">
     
     
     
     
     
     
     
    <unitStart name="calculate__tf" line="4" type="PROCEDURE" outputs="tf,tf_csv"/>
    <vdl:execute>
      <vdl:tr>python</vdl:tr>
      <vdl:stagein var="{calc_tf}"/>
      <vdl:stagein var="{dir}"/>
      <vdl:stagein var="{doc}"/>
      <vdl:stagein var="{topn}"/>
      <vdl:stagein var="{minf}"/>
      <vdl:stageout var="{tf}"/>
      <vdl:stageout var="{tf_csv}"/>

      <vdl:arguments>
        <swiftscript:filename _traceline="5">
         <variable>calc_tf</variable> 
        </swiftscript:filename>
        <variable>dir</variable>
        <variable>topn</variable>
        <variable>minf</variable>
        <swiftscript:filename _traceline="5">
         <variable>tf</variable> 
        </swiftscript:filename>
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{tf}"/>
    <vdl:closedataset var="{tf_csv}"/>
    <unitEnd name="calculate__tf" line="4" type="PROCEDURE"/></element>

  <element name="merger" arguments="o,merge,doc" _defline="8">
     
     
     
    <unitStart name="merger" line="8" type="PROCEDURE" outputs="o"/>
    <vdl:execute>
      <vdl:tr>python_local</vdl:tr>
      <vdl:stagein var="{merge}"/>
      <vdl:stagein var="{doc}"/>
      <vdl:stageout var="{o}"/>

      <vdl:arguments>
        <swiftscript:filename _traceline="9">
         <variable>merge</variable> 
        </swiftscript:filename>
        <swiftscript:filename _traceline="9">
         <variable>o</variable> 
        </swiftscript:filename>
        <swiftscript:filenames _traceline="9">
         <variable>doc</variable> 
        </swiftscript:filenames>
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{o}"/>
    <unitEnd name="merger" line="8" type="PROCEDURE"/></element>

  <element name="calculate__idf" arguments="tfidf,calc,tf,key,report_top" _defline="12">
     
     
     
     
     
    <unitStart name="calculate__idf" line="12" type="PROCEDURE" outputs="tfidf"/>
    <vdl:execute>
      <vdl:tr>python</vdl:tr>
      <vdl:stagein var="{calc}"/>
      <vdl:stagein var="{tf}"/>
      <vdl:stagein var="{key}"/>
      <vdl:stagein var="{report_top}"/>
      <vdl:stageout var="{tfidf}"/>

      <vdl:arguments>
        <swiftscript:filename _traceline="13">
         <variable>calc</variable> 
        </swiftscript:filename>
        <variable>report_top</variable>
        <swiftscript:filename _traceline="13">
         <variable>tf</variable> 
        </swiftscript:filename>
        <variable>key</variable>
      </vdl:arguments>
      <vdl:stdout>
        <swiftscript:filename _traceline="13">
         <variable>tfidf</variable> 
        </swiftscript:filename>
      </vdl:stdout>
    </vdl:execute>
    <vdl:closedataset var="{tfidf}"/>
    <unitEnd name="calculate__idf" line="12" type="PROCEDURE"/></element>

  <element name="scrounge" arguments="final,s,i" _defline="16">
     
     
     
    <unitStart name="scrounge" line="16" type="PROCEDURE" outputs="final"/>
    <vdl:execute>
      <vdl:tr>bash</vdl:tr>
      <vdl:stagein var="{s}"/>
      <vdl:stagein var="{i}"/>
      <vdl:stageout var="{final}"/>

      <vdl:arguments>
        <swiftscript:filename _traceline="17">
         <variable>s</variable> 
        </swiftscript:filename>
        <swiftscript:filename _traceline="17">
         <variable>i</variable> 
        </swiftscript:filename>
      </vdl:arguments>
      <vdl:stdout>
        <swiftscript:filename _traceline="17">
         <variable>final</variable> 
        </swiftscript:filename>
      </vdl:stdout>
    </vdl:execute>
    <vdl:closedataset var="{final}"/>
    <unitEnd name="scrounge" line="16" type="PROCEDURE"/></element>

  <set name="dir">
        <vdl:new type="string" dbgname="dir" waitCount="1" _defline="20"/>
  </set>
   
  <set name="report_top">
        <vdl:new type="string" dbgname="report_top" waitCount="1" _defline="21"/>
  </set>
   
  <set name="min_freq">
        <vdl:new type="string" dbgname="min_freq" waitCount="1" _defline="22"/>
  </set>
   
  <set name="calc_tf">
        <vdl:new type="script" dbgname="calc_tf" _defline="25" input="true">
          <vdl:mapping descriptor="single_file_mapper">
            <vdl:parameter name="file" value="calculate_tf_scores.py"/>
          </vdl:mapping>
        </vdl:new>
  </set>
   
  <set name="swift#mapper#17003">
        <vdl:new type="string" dbgname="swift#mapper#17003" _defline=""/>
  </set>
   
  <set name="all_docs">
    <vdl:new type="file[]" dbgname="all_docs" _defline="26" input="true">
      <vdl:mapping descriptor="filesys_mapper">
        <vdl:parameter name="location"><variable>dir</variable></vdl:parameter>
        <vdl:parameter name="suffix"><vdl:new type="string" value=".txt" /></vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="doc_tf">
    <vdl:new type="file[]" dbgname="doc_tf" waitCount="1" _defline="27">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix">doc_tf-1bd25e8f-8d01-409d-89ed-eb35feb3bd36</vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="merge">
        <vdl:new type="script" dbgname="merge" _defline="36" input="true">
          <vdl:mapping descriptor="single_file_mapper">
            <vdl:parameter name="file" value="merge.py"/>
          </vdl:mapping>
        </vdl:new>
  </set>
   
  <set name="swift#mapper#17009">
        <vdl:new type="string" dbgname="swift#mapper#17009" _defline=""/>
  </set>
   
  <set name="all_tf">
    <vdl:new type="file" dbgname="all_tf" _defline="37">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file"><variable>swift#mapper#17009</variable></vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="tfidf">
    <vdl:new type="file[]" dbgname="tfidf" waitCount="1" _defline="41">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix">tfidf-de94f439-a075-46c2-8198-b840edfec9bd</vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="calc_idf">
        <vdl:new type="script" dbgname="calc_idf" _defline="42" input="true">
          <vdl:mapping descriptor="single_file_mapper">
            <vdl:parameter name="file" value="calculate_idf_scores.py"/>
          </vdl:mapping>
        </vdl:new>
  </set>
   
  <set name="concat">
        <vdl:new type="script" dbgname="concat" _defline="50" input="true">
          <vdl:mapping descriptor="single_file_mapper">
            <vdl:parameter name="file" value="concat.sh"/>
          </vdl:mapping>
        </vdl:new>
  </set>
   
  <set name="swift#mapper#17013">
        <vdl:new type="string" dbgname="swift#mapper#17013" _defline=""/>
  </set>
   
  <set name="final">
    <vdl:new type="file" dbgname="final" _defline="51">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file"><variable>swift#mapper#17013</variable></vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <restartLog>
  	<vdl:mains>
		<vdl:startprogressticker />
		<vdl:mainp>
		    <uparallel>
		        <sequential>
		             <vdl:setfieldvalue _traceline="21">
		                 <variable>dir</variable>
		                 <swiftscript:arg _traceline="20">
		                  <variable>swift#string#17000</variable> 
		                 </swiftscript:arg>
		             </vdl:setfieldvalue>
		             <partialCloseDataset var="{dir}"/>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="22">
		                 <variable>report_top</variable>
		                 <swiftscript:arg _traceline="21">
		                  <variable>swift#string#17001</variable> 
		                 </swiftscript:arg>
		             </vdl:setfieldvalue>
		             <partialCloseDataset var="{report_top}"/>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="25">
		                 <variable>min_freq</variable>
		                 <swiftscript:arg _traceline="22">
		                  <variable>swift#string#17002</variable> 
		                 </swiftscript:arg>
		             </vdl:setfieldvalue>
		             <partialCloseDataset var="{min_freq}"/>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="-1">
		                 <variable>swift#mapper#17003</variable>
		                 <variable>swift#string#17004</variable>
		             </vdl:setfieldvalue>

		        </sequential>
		        <sequential>
		          <vdl:tparallelFor name="$"_kvar="index" _vvar="doc" refs="doc_tf 1">
		          	<getarrayiterator>
		          		<variable>all_docs</variable>
		          	</getarrayiterator>
		          	<set names="$$, doc">
		          		<each items="{$}"/>
		          	</set>
		          	<set name="index">
		          		<vdl:new type="int" value="{$$}"/>
		          	</set>
		          	<unitStart line="28" type="FOREACH_IT"/>
		          	<set name="swift#mapper#17005">
		          	      <vdl:new type="string" dbgname="swift#mapper#17005" _defline=""/>
		          	</set>
		          	 
		          	<set name="tf">
		          	  <vdl:new type="file" dbgname="tf" _defline="29">
		          	    <vdl:mapping descriptor="single_file_mapper">
		          	      <vdl:parameter name="file"><variable>swift#mapper#17005</variable></vdl:parameter>
		          	    </vdl:mapping>
		          	  </vdl:new>
		          	</set>
		          	 
		          	<set name="swift#mapper#17007">
		          	      <vdl:new type="string" dbgname="swift#mapper#17007" _defline=""/>
		          	</set>
		          	 
		          	<set name="tf_csv">
		          	  <vdl:new type="file" dbgname="tf_csv" _defline="30">
		          	    <vdl:mapping descriptor="single_file_mapper">
		          	      <vdl:parameter name="file"><variable>swift#mapper#17007</variable></vdl:parameter>
		          	    </vdl:mapping>
		          	  </vdl:new>
		          	</set>
		          	 
		          	<uparallel>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="-1">
		          	             <variable>swift#mapper#17005</variable>
		          	             <swiftscript:strcat _traceline="29">
		          	              <swiftscript:filename _traceline="29">
		          	              <variable>doc</variable> 
		          	             </swiftscript:filename><variable>swift#string#17006</variable> 
		          	             </swiftscript:strcat>
		          	         </vdl:setfieldvalue>

		          	    </sequential>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="-1">
		          	             <variable>swift#mapper#17007</variable>
		          	             <swiftscript:strcat _traceline="30">
		          	              <swiftscript:filename _traceline="30">
		          	              <variable>doc</variable> 
		          	             </swiftscript:filename><variable>swift#string#17008</variable> 
		          	             </swiftscript:strcat>
		          	         </vdl:setfieldvalue>

		          	    </sequential>
		          	    <sequential>
		          	      <calculate__tf _traceline="31">
		          	          <variable>tf</variable>
		          	          <variable>tf_csv</variable>
		          	          <variable>calc_tf</variable>
		          	          <variable>dir</variable>
		          	          <variable>doc</variable>
		          	          <variable>report_top</variable>
		          	          <variable>min_freq</variable>
		          	      </calculate__tf>

		          	    </sequential>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="33">
		          	             <vdl:getfieldsubscript>
		          	               <argument name="var"><variable>doc_tf</variable></argument>
		          	               <argument name="subscript"><variable>index</variable></argument>
		          	             </vdl:getfieldsubscript>
		          	             <variable>tf</variable>
		          	         </vdl:setfieldvalue>
		          	         <partialCloseDataset var="{doc_tf}"/>
		          	    </sequential>
		          	</uparallel>
		          	<vdl:cleandataset var="{tf}"/>
		          	<vdl:cleandataset var="{tf_csv}"/>	<unitEnd line="28" type="FOREACH_IT"/>
		          </vdl:tparallelFor>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="-1">
		                 <variable>swift#mapper#17009</variable>
		                 <swiftscript:strcat _traceline="37">
		                  <variable>dir</variable><variable>swift#string#17010</variable> 
		                 </swiftscript:strcat>
		             </vdl:setfieldvalue>

		        </sequential>
		        <sequential>
		          <merger _traceline="38">
		              <variable>all_tf</variable>
		              <variable>merge</variable>
		              <variable>doc_tf</variable>
		          </merger>

		        </sequential>
		        <sequential>
		          <vdl:tparallelFor name="$"_kvar="index" _vvar="doc" refs="tfidf 1">
		          	<getarrayiterator>
		          		<variable>all_docs</variable>
		          	</getarrayiterator>
		          	<set names="$$, doc">
		          		<each items="{$}"/>
		          	</set>
		          	<set name="index">
		          		<vdl:new type="int" value="{$$}"/>
		          	</set>
		          	<unitStart line="43" type="FOREACH_IT"/>
		          	<set name="swift#mapper#17011">
		          	      <vdl:new type="string" dbgname="swift#mapper#17011" _defline=""/>
		          	</set>
		          	 
		          	<set name="tfidf_t">
		          	  <vdl:new type="file" dbgname="tfidf_t" _defline="44">
		          	    <vdl:mapping descriptor="single_file_mapper">
		          	      <vdl:parameter name="file"><variable>swift#mapper#17011</variable></vdl:parameter>
		          	    </vdl:mapping>
		          	  </vdl:new>
		          	</set>
		          	 
		          	<uparallel>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="-1">
		          	             <variable>swift#mapper#17011</variable>
		          	             <swiftscript:strcat _traceline="44">
		          	              <swiftscript:filename _traceline="44">
		          	              <variable>doc</variable> 
		          	             </swiftscript:filename><variable>swift#string#17012</variable> 
		          	             </swiftscript:strcat>
		          	         </vdl:setfieldvalue>

		          	    </sequential>
		          	    <sequential>
		          	      <calculate__idf _traceline="45">
		          	      <parallel>
		          	          <variable>tfidf_t</variable>
		          	          <variable>calc_idf</variable>
		          	          <variable>all_tf</variable>
		          	          <swiftscript:filename _traceline="45">
		          	           <variable>doc</variable> 
		          	          </swiftscript:filename>
		          	          <variable>report_top</variable>
		          	      </parallel>
		          	      </calculate__idf>

		          	    </sequential>
		          	    <sequential>
		          	         <vdl:setfieldvalue _traceline="47">
		          	             <vdl:getfieldsubscript>
		          	               <argument name="var"><variable>tfidf</variable></argument>
		          	               <argument name="subscript"><variable>index</variable></argument>
		          	             </vdl:getfieldsubscript>
		          	             <variable>tfidf_t</variable>
		          	         </vdl:setfieldvalue>
		          	         <partialCloseDataset var="{tfidf}"/>
		          	    </sequential>
		          	</uparallel>
		          	<vdl:cleandataset var="{tfidf_t}"/>	<unitEnd line="43" type="FOREACH_IT"/>
		          </vdl:tparallelFor>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="-1">
		                 <variable>swift#mapper#17013</variable>
		                 <swiftscript:strcat _traceline="51">
		                  <variable>dir</variable><variable>swift#string#17014</variable> 
		                 </swiftscript:strcat>
		             </vdl:setfieldvalue>

		        </sequential>
		        <sequential>
		          <scrounge _traceline="52">
		              <variable>final</variable>
		              <variable>concat</variable>
		              <variable>tfidf</variable>
		          </scrounge>

		        </sequential>
		    </uparallel>
		</vdl:mainp>
		<vdl:stopprogressticker />
	</vdl:mains>
  </restartLog>
  <vdl:cleandataset var="{final}"/>
  <vdl:cleandataset var="{tfidf}"/>
  <vdl:cleandataset var="{calc_idf}"/>
  <vdl:cleandataset var="{merge}"/>
  <vdl:cleandataset var="{calc_tf}"/>
  <vdl:cleandataset var="{all_tf}"/>
  <vdl:cleandataset var="{concat}"/>
  <vdl:cleandataset var="{all_docs}"/>
  <vdl:cleandataset var="{doc_tf}"/>
  <vdl:cleandataset shutdown="true"/>
</project>
